<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loop 2 — Loan Tool (Better)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-gray-100 p-6">
  <main class="mx-auto max-w-5xl grid md:grid-cols-2 gap-6">
    <section class="bg-white shadow-xl rounded-2xl p-6 space-y-4">
      <header class="space-y-1">
        <h1 class="text-2xl font-bold">Loan Tool (Loop 2)</h1>
        <p class="text-sm text-gray-500">Adds validation, shareable URL, balance chart, and 12-month schedule.</p>
      </header>

      <div class="grid grid-cols-2 gap-4">
        <label class="col-span-2">
          <span class="text-sm font-medium">Loan Amount ($)</span>
          <input id="amount" type="number" min="0" step="0.01" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g., 25000" />
        </label>

        <label>
          <span class="text-sm font-medium">Annual Rate (%)</span>
          <input id="rate" type="number" min="0" step="0.01" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g., 6.5" />
        </label>

        <label>
          <span class="text-sm font-medium">Term (years)</span>
          <input id="years" type="number" min="0" step="0.1" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="e.g., 5" />
        </label>
      </div>

      <div class="flex gap-3">
        <button id="calc" class="flex-1 rounded-xl bg-indigo-600 text-white py-2.5 font-medium hover:bg-indigo-700">Calculate</button>
        <button id="share" class="rounded-xl border py-2.5 px-4 hover:bg-gray-50">Copy Share Link</button>
      </div>

      <section id="cards" class="hidden grid grid-cols-2 gap-4">
        <div class="rounded-xl bg-gray-50 p-4">
          <p class="text-xs text-gray-600">Monthly Payment</p>
          <p id="payment" class="text-3xl font-bold tracking-tight">$0.00</p>
        </div>
        <div class="rounded-xl bg-gray-50 p-4">
          <p class="text-xs text-gray-600">Total Interest</p>
          <p id="interest" class="text-3xl font-bold tracking-tight">$0.00</p>
        </div>
      </section>

      <section id="scheduleWrap" class="hidden">
        <h2 class="mt-2 font-semibold">First 12 Months (Amortization)</h2>
        <div class="overflow-x-auto rounded-xl border">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-right">Payment</th>
                <th class="px-3 py-2 text-right">Interest</th>
                <th class="px-3 py-2 text-right">Principal</th>
                <th class="px-3 py-2 text-right">Balance</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
      </section>
    </section>

    <section class="bg-white shadow-xl rounded-2xl p-6 space-y-4">
      <h2 class="text-lg font-semibold">Balance Over Time</h2>
      <canvas id="chart" height="280" class="rounded-xl border"></canvas>

      <details class="text-sm text-gray-600">
        <summary class="cursor-pointer select-none">What changed from Loop 1?</summary>
        <ul class="list-disc ml-5 mt-2 space-y-1">
          <li>Input validation with friendly errors.</li>
          <li>Shareable URL (includes inputs in the query string).</li>
          <li>12-month amortization preview table.</li>
          <li>Interactive chart of remaining balance.</li>
        </ul>
      </details>
    </section>
  </main>

<script>
function fmtUSD(x){ return x.toLocaleString(undefined,{style:'currency',currency:'USD'}); }
function parseNum(id){ return Number(document.getElementById(id).value); }

function validate(P, annual, years){
  const errors = [];
  if(!(P>0)) errors.push('Loan amount must be > 0');
  if(!(years>0)) errors.push('Term (years) must be > 0');
  if(!(annual>=0)) errors.push('Rate must be ≥ 0');
  return errors;
}

function pmt(P, annual, years){
  const n = Math.round(years*12);
  const r = (annual/100)/12;
  if (n === 0) return {payment:NaN, n, r};
  if (r === 0) return {payment: P / n, n, r};
  const pow = Math.pow(1+r, n);
  return {payment: P * r * pow / (pow - 1), n, r};
}

function amortize(P, payment, n, r){
  const sched = [];
  let bal = P;
  let totalInterest = 0;
  for(let i=1;i<=n;i++){
    const interest = r === 0 ? 0 : bal * r;
    const principal = Math.min(payment - interest, bal);
    bal = Math.max(0, bal - principal);
    totalInterest += interest;
    sched.push({period:i, payment, interest, principal, balance:bal});
  }
  return {sched, totalInterest};
}

let chart;
function renderChart(balances){
  const ctx = document.getElementById('chart');
  if(chart){ chart.destroy(); }
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: balances.map((_,i)=>i),
      datasets: [{
        label: 'Remaining Balance',
        data: balances,
        borderColor: '#4f46e5',
        backgroundColor: '#c7d2fe',
        fill: true,
        tension: 0.15
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Month' } },
        y: { title: { display: true, text: 'Balance ($)' } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

function writeSchedulePreview(rows){
  const body = document.getElementById('scheduleBody');
  body.innerHTML = '';
  rows.slice(0,12).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-3 py-2">${r.period}</td>
      <td class="px-3 py-2 text-right">${fmtUSD(r.payment)}</td>
      <td class="px-3 py-2 text-right">${fmtUSD(r.interest)}</td>
      <td class="px-3 py-2 text-right">${fmtUSD(r.principal)}</td>
      <td class="px-3 py-2 text-right">${fmtUSD(r.balance)}</td>
    `;
    body.appendChild(tr);
  });
}

function calcAndRender(){
  const P = parseNum('amount'), annual = parseNum('rate'), years = parseNum('years');
  const errs = validate(P, annual, years);
  if (errs.length){
    alert('Fix these:\n- ' + errs.join('\n- '));
    return;
  }
  const {payment, n, r} = pmt(P, annual, years);
  const {sched, totalInterest} = amortize(P, payment, n, r);
  document.getElementById('payment').textContent = fmtUSD(payment);
  document.getElementById('interest').textContent = fmtUSD(totalInterest);
  document.getElementById('cards').classList.remove('hidden');
  document.getElementById('scheduleWrap').classList.remove('hidden');
  writeSchedulePreview(sched);
  renderChart([P, ...sched.map(s=>s.balance)]);
}

function loadFromQuery(){
  const params = new URLSearchParams(location.search);
  ['amount','rate','years'].forEach(id => {
    if(params.has(id)){
      document.getElementById(id).value = params.get(id);
    }
  });
}

document.getElementById('calc').addEventListener('click', calcAndRender);

document.getElementById('share').addEventListener('click', () => {
  const P = parseNum('amount'), annual = parseNum('rate'), years = parseNum('years');
  const url = new URL(location.href);
  url.searchParams.set('amount', isFinite(P)?P:'');
  url.searchParams.set('rate', isFinite(annual)?annual:'');
  url.searchParams.set('years', isFinite(years)?years:'');
  navigator.clipboard.writeText(url.toString()).then(()=>{
    alert('Link copied! Paste it to share these inputs.');
  });
});

loadFromQuery();
</script>
</body>
</html>
